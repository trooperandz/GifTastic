/**
 * Program: gif.js
 * Created: 08/30/2016 by Matt Holland
 * Located: desktop/bootcamp/homework/giftastic/assets/javascript
 * Purpose: Provide gif generation code for 6th assignment - AJAX
 */

 // Main API object
 var gif = {

 	// Main array that holds all topics
 	topicArray: ["Lightning", "Whales", "Waterfalls", "Mudslides", "Tasmanian Devils", "Coral Reefs"],

 	// Image state global, for changing <img> src attribute. Initialize to still. Prevents you from having to pass parameter to changeImgUrl
 	imgState: "still",

 	// Hold new topics added in another array so that items may be removed in the future when user selects "Clear Data"
 	newTopicArray: [],

 	/**
 	 * Populate default buttons on page load, from topicArray
	 * @param {array} items The array of topics
	 * @param {string} action "rerender" or null determines emptying of content
	 * @return N/A
	 */
 	generateDefaultButtons: function(items, action) {
 		// If user clicks "Clear Data" button, clear out the topic buttons list on side panel for re-rendering
 		if(action == "rerender") {
 			$("div#button-area").empty();
 		}
 		console.log("var items inside of generateDefaultButtons(): " + items);
 		// Get the parent element which will house the buttons
 		var parent = $("div#button-area");
 		// Loop through the array of topics and generate the default button list
 		//gif.topicArray.forEach(function(item, index, arr) {
 		items.forEach(function(item, index, arr) {
 			// Create the button inside of the li
 			var li = $('<li><button class="btn side-btn" data-topic="' + item + '"> ' + item + ' &raquo; </button></li>');
 			// Now append the li to the parent
 			parent.append(li);
 		});
 	},

 	/** 
 	 * Generate a new button when the user clicks on the generate input
 	 * @param {string} topic The topic that the user entered
 	 * @return N/A
 	 */
 	generateNewButton: function(topic) {
 		// First check to see if topic already exists.  If so, deny addition
 		if(gif.topicArray.indexOf(topic) != -1) {
 			this.showModal("That topic already exists! Please choose another one.");
 			return false;
 		}

 		// Unshift (push) new topic onto beginning of main array (so that page reload maintains same order of topic array as 
 		// display after append topic instruction). Also append to temp array (will be used later for removing new topics)
 		gif.topicArray.unshift(topic);
 		gif.newTopicArray.push(topic);

 		// Save to session storage so that buttons generated by user may be saved
 		sessionStorage.setItem("topicArray", gif.topicArray);

 		// Get the parent element which button will be prepended to
 		var parent = $("div#button-area");

 		// Create the new button element
 		var li = $('<li><button class="btn side-btn" data-topic="' + topic + '"> ' + topic + ' &raquo; </button></li>');
 		// Prepend the button to the sidebar
 		parent.prepend(li);
 	},

 	/** 
 	 * Generate gif content when the user clicks on a topic button
 	 * @param {string} topic The topic string represented by the button click
 	 * @return N/A
 	 */
 	generateGifs: function(topic) {

 		// Get the parent element which content will be prepended to
 		var parent = $("div#gif-content");

 		// Make sure that the topic string is encoded properly (+ for spaces)
 		var topic = encodeURIComponent(topic).replace(/%20/g,'+');

 		// Establish query URL, metting GIPHY API requirements
 		var queryUrl = "http://api.giphy.com/v1/gifs/search?q=" + topic + "&api_key=dc6zaTOxFJmzC&limit=12";
 		console.log("queryUrl: " + queryUrl);

 		// AJAX call to get data
 		$.ajax({
 			url: queryUrl, 
 			method: "GET"
 		}).done(function(returnData) {
 			console.log(returnData);
 			var stuff = "";

 			// Loop through returnData.  Note:  is an object.  Must reference 'data' to access the array
 			returnData.data.forEach(function(item,index,arr) {
 				// Make sure that there is text for rating.  If not, will throw off layout rows. Make all ratings upper-case for good presentation
 				var rating = (arr[index].rating == "") ? "N/A" : arr[index].rating.toUpperCase();

 				// Add all html into var stuff
 				stuff += '<div class="col-xs-6 col-sm-6 col-md-4 col-lg-3 placeholder">' +
                        	'<img src="' + arr[index].images.fixed_height_still.url + '" data-still="' + arr[index].images.fixed_height_still.url + '" data-animate="' + arr[index].images.fixed_height.url + '" width="auto" height="200" class="img-responsive" alt="Generic placeholder thumbnail">' +
                        	'<h4>Rating</h4>' + 
                        	'<span class="rating">' + rating + '</span>' +
                    	  '</div>';
 				//console.log("img animated string: " + arr[index].images.fixed_height.url + "\n img still string: " + arr[index].images.fixed_height_still.url + "\n + rating: " + arr[index].rating);
 			});

 			// Throw stuff into main img container
 			$('div#gif-content').html(stuff);
 		})
 	}, 

 	/** 
 	 * Change the img "src" attribute, to animated or still the gif
 	 * @param {object} img The image that the user clicked
 	 * @return N/A
 	 */
 	changeImgUrl: function(img) {
 		// Get the url string, and then change the src attribute
 		var url = (gif.imgState == "still") ? img.data("animate") : img.data("still");
 		img.attr("src", url);
 		
 		// Change the state to the alternative option, so that next time the src will switch
 		gif.imgState = (gif.imgState == "still") ? "animate" : "still";
 	},

 	/**
 	 * Update the main heading to reflect the topic being browsed
 	 * @param {string} topic Subject entered into search field
 	 * @return N/A
 	 */
 	updateMainHeading: function(topic) {
 		// Fill in the h1 content with "Now Browsing..." and update topic content
 		$('h1.page-header').html('Now Browsing...<span class="header-span">' + topic + '</span>');
 	},

 	/**
 	 * Clear the session storage (localStorage) data == array of topics
 	 * @param N/A
 	 * @return {boolean} true Return if localStorage != null
 	 */
 	clearStorage: function() {
 		// First, check to see if storage is empty
 		if(localStorage.getItem("topicArray") == null) {
 			this.showModal("There is no session data to clear!");
 		} else {
 			localStorage.clear("topicArray");
 			// Show modal msg to user confirming that data was cleared
 			this.showModal("You successfully cleared the session data!");
 			// Remove new items from original topic array
 			gif.restoreTopicArray();
 			// Return true so that generateDefaultButtons will only run after topicArray clearing has completed (else dupe error may trigger)
 			return true;
 		}
 	},

 	/**
 	 * Remove items in newTopicArray from original topicArray for restoring original 
 	 * topics list after "Clear Data" button is clicked by user.
 	 * @param N/A
 	 * @return N/A
 	 */
 	restoreTopicArray: function() {
 		// Run through each item in newTopicArray, removing matches found in topicArray (every item will match ALWAYS)
 		gif.newTopicArray.forEach(function(item, index, arr) {
 			var index = gif.topicArray.indexOf(item);
 			if(index != -1) {
 				gif.topicArray.splice(index, 1);
 			}
 		});
 	},

 	/**
 	 * Display modal to user if important msg is needed
 	 * @param {string} msg Message to transmit to user
 	 * @return N/A
 	 */
 	 showModal: function(msg) {
 	 	$('p#modal-msg').text(msg);
 	 	$('.modal').modal("show");
 	 }
 }

// Main program executable code
 $(document).ready(function() {

 	// Generate the default buttons on page load. Check session storage first, and generate from there if != null
 	// Note: var action dictates <ul> button list empty() instruction, to be executed only when clearing session data
 	var items = localStorage.getItem("topicArray");
 	if(items != null) {
 		items = JSON.parse(items);
 		var action = null;
 		gif.generateDefaultButtons(items, action);
 	} else {
 		var items = gif.topicArray;
 		var action = null;
 		gif.generateDefaultButtons(items, action);
 	}

 	// When the user clicks on the search icon, generate a new button AND generate gif content
 	$('span.search-icon').on('click', function(e) {
 		// Get the input text. Trim out any white space
 		var text = $('input.input-generate').val().trim();

 		// Make sure the user entered something. Show modal msg if they didn't
 		if(text == "") {
 			gif.showModal("You must enter a topic before continuing!");
 			return false;
 		}

 		// Generate a new button with the user's input, and add topic to default and new topic arrays
 		gif.generateNewButton(text);

 		// Save entire topicArray to local storage
 		localStorage.setItem("topicArray", JSON.stringify(gif.topicArray));

 		// Update main heading text
 		gif.updateMainHeading(text);

 		// Run the function to generate the GIFs
 		gif.generateGifs(text);

 		// Clear out the topic input element
 		$('.input-generate').html("");
 	});

 	// When the user clicks on a topic button, generate the gifs
 	$('ul.nav-sidebar').on('click', 'button', function(e) {

 		// Get the data attribute of the button clicked
 		var topic = $(this).data("topic");

 		// Update main heading text
 		gif.updateMainHeading(topic);

 		// Run the function to generate GIFs
 		gif.generateGifs(topic);
 	});

 	// When the user clicks on an img, make it animate, or still
 	$('div.main').on('click','img', function(e) {
 		var img = $(e.target);
 		gif.changeImgUrl(img);
 	});

 	// When user clicks on "Clear Data" button, clear the localStorage topic array if it exists
 	$('button.clear-btn').on('click', function() {
 		// Set action so that default button generation correctly empties out the buttons on the side panel
 		var action = "rerender";
 		// Wait until clearStorage returns true, and then generate the default buttons again
 		if(gif.clearStorage()) { 
 			// Note: need to clear out the new topicArray items so that the error "Topic already exists" does not show
 			gif.generateDefaultButtons(gif.topicArray, action);
 		}
 	});

 	// Allow user to create new button via the "Enter" key
 	$(".input-generate").keypress(function(e) {
        if (e.which == 13) {
            $("span.search-icon").click();
        }
    });
});